<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Scantist Web Pentest Record | Grey Zone</title><meta name="description" content="url: https:&#x2F;&#x2F;staging.scantist.io&#x2F;login api doc: https:&#x2F;&#x2F;api-staging.scantist.io&#x2F;docs (I thought that I need to fuzz the whole API. Luckily I found the doc after the first few minutes of fuzzing throug"><meta name="keywords" content="OffSec"><meta name="author" content="Grey Deng"><meta name="copyright" content="Grey Deng"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://victomteng1997.github.io/2020/04/14/scantist-web-pentest-record/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Scantist Web Pentest Record"><meta property="og:url" content="https://victomteng1997.github.io/2020/04/14/scantist-web-pentest-record/"><meta property="og:site_name" content="Grey Zone"><meta property="og:description" content="url: https:&#x2F;&#x2F;staging.scantist.io&#x2F;login api doc: https:&#x2F;&#x2F;api-staging.scantist.io&#x2F;docs (I thought that I need to fuzz the whole API. Luckily I found the doc after the first few minutes of fuzzing throug"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-04-14T12:28:27.000Z"><meta property="article:modified_time" content="2020-07-31T14:20:01.260Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="[HTB Walkthrough] Magic" href="https://victomteng1997.github.io/2020/04/22/htb-walkthrough-magic/"><link rel="next" title="[HTB Walkthrough] Remote" href="https://victomteng1997.github.io/2020/04/04/htb-walkthrough-remote/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">23</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Recon"><span class="toc-number">1.</span> <span class="toc-text">1. Recon</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Allow-crawling-of-all-content"><span class="toc-number"></span> <span class="toc-text">Allow crawling of all content</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Login-Page"><span class="toc-number">1.</span> <span class="toc-text">2. Login Page</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-File-Upload-Function"><span class="toc-number">2.</span> <span class="toc-text">3. File Upload Function</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#following-sections-are-neglected"><span class="toc-number"></span> <span class="toc-text">following sections are neglected</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Attacks-on-File-Upload-Function-Directory-enumeration-on-api"><span class="toc-number">0.1.</span> <span class="toc-text">Attacks on File Upload Function: Directory enumeration on api</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Abuse-File-Upload-Function-JSON-record-modification"><span class="toc-number">0.2.</span> <span class="toc-text">Abuse File Upload Function: JSON record modification</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Attack-File-Upload-Function-Possible-Code-Execution"><span class="toc-number">0.3.</span> <span class="toc-text">Attack File Upload Function: Possible Code Execution</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Grey Zone</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Scantist Web Pentest Record</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-04-14 20:28:27"><i class="far fa-calendar-alt fa-fw"></i> Created 2020-04-14</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-07-31 22:20:01"><i class="fas fa-history fa-fw"></i> Updated 2020-07-31</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>url: <a href="https://staging.scantist.io/login" target="_blank" rel="noopener">https://staging.scantist.io/login</a> api doc: <a href="https://api-staging.scantist.io/docs" target="_blank" rel="noopener">https://api-staging.scantist.io/docs</a> (I thought that I need to fuzz the whole API. Luckily I found the doc after the first few minutes of fuzzing through <strong>wfuzz</strong>). For the attacks, you may directly go to section 3.</p>
<h5 id="1-Recon"><a href="#1-Recon" class="headerlink" title="1. Recon"></a>1. Recon</h5><p>ip lookup: <strong>Amazon CloudFront</strong> Singapore Server, ip <strong>54.192.151.100</strong> <strong>nmap</strong> result:</p>
<p>PORT STATE SERVICE VERSION<br>80/tcp open http Amazon CloudFront httpd<br>| http-methods:<br>|_ Supported Methods: GET HEAD POST OPTIONS<br>|_http-server-header: CloudFront<br>|_http-title: Did not follow redirect to <a href="https://staging.scantist.io/" target="_blank" rel="noopener">https://staging.scantist.io/</a><br>443/tcp open ssl<br>|_http-server-header: CloudFront<br>|_http-title: ERROR: The request could not be satisfied<br>Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port<br>Device type: WAP|general purpose<br>Running: Actiontec embedded, Linux 2.4.X|3.X, Microsoft Windows XP|7|2012<br>OS CPE: cpe:/h:actiontec:mi424wr-gen3i cpe:/o:linux:linux_kernel cpe:/o:linux:linux_kernel:2.4.37 cpe:/o:linux:linux_kernel:3.2 cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_server_2012<br>OS details: Actiontec MI424WR-GEN3I WAP, DD-WRT v24-sp2 (Linux 2.4.37), Linux 3.2, Microsoft Windows XP SP3, Microsoft Windows XP SP3 or Windows 7 or Windows Server 2012<br>Network Distance: 2 hops<br>TCP Sequence Prediction: Difficulty=256 (Good luck!)<br>IP ID Sequence Generation: Incremental</p>
<p>Some quick, intuitive thoughts: /robots.txt</p>
<p># <a href="http://www.robotstxt.org/" target="_blank" rel="noopener">www.robotstxt.org/</a></p>
<h1 id="Allow-crawling-of-all-content"><a href="#Allow-crawling-of-all-content" class="headerlink" title="Allow crawling of all content"></a>Allow crawling of all content</h1><p>User-agent: *<br>Disallow:</p>
<p><strong>DirBuster:</strong> There are several directories well protected. The most interesting files are listed below: <strong>/setting/env.js</strong></p>
<p>// prettier-ignore<br>var env = {<br>  “NODE_ENV”: “staging”,<br>  “API_BASE”: “<a href="https://api-staging.scantist.io/v1&quot;" target="_blank" rel="noopener">https://api-staging.scantist.io/v1&quot;</a>,<br>  “PUSHER_KEY”: “765ec374ae0a69f4ce44”,<br>  “PUSHER_HOST”: “api-staging.scantist.io”,<br>  “PUSHER_PORT”: 8082,<br>  “GITHUB_CLIENT_ID”: “8ebd199ca3dd2846ba99”,<br>  “GITHUB_OAUTH_SCOPE”: “user:email,repo”,<br>  “GITLAB_CLIENT_ID”:<br>    “9ab685da0bf18f92ca75e3e87b729f9a688eeda555b8deba9ccc06729d2d89b4”,<br>  “GITLAB_OAUTH_SCOPE”: “read_user+read_repository+api”,<br>  “GITHUB_URL”: “<a href="https://github.com&quot;" target="_blank" rel="noopener">https://github.com&quot;</a>,<br>  “GITLAB_URL”: “<a href="https://gitlab.com&quot;" target="_blank" rel="noopener">https://gitlab.com&quot;</a>,<br>  “CLIENT_URL”: “<a href="https://staging.scantist.io/callback&quot;" target="_blank" rel="noopener">https://staging.scantist.io/callback&quot;</a>,<br>  “BITBUCKET_CLIENT_ID”: “8nUrxhwtrR6Tv9rRQE”,<br>  “BITBUCKET_OAUTH_SCOPE”: “”,<br>  “BITBUCKET_URL”: “<a href="https://bitbucket.org/site&quot;" target="_blank" rel="noopener">https://bitbucket.org/site&quot;</a>,<br>  “BITBUCKET_SERVER”: “<a href="http://13.250.81.217:7990&quot;">http://13.250.81.217:7990&quot;</a>,<br>  “SENTRY_DSN”: “<a href="https://9e3bec10de7d4173afccfef99a4e7c4e@sentry.io/265321&quot;" target="_blank" rel="noopener">https://9e3bec10de7d4173afccfef99a4e7c4e@sentry.io/265321&quot;</a>,<br>  “STRIPE_PUBLIC_KEY”: “pk_live_ORr4CMaMUojrPTm4euEcbRJy”,<br>  “CLIENT_ROOT”: “<a href="https://staging.scantist.io&quot;" target="_blank" rel="noopener">https://staging.scantist.io&quot;</a>,<br>  “IS_ON_PREM”: “false”,<br>  “IS_CHINESE_VERSION”: “false”,<br>  “IS_BITBUCKET_SERVER”: “false”,<br>  “UPLOAD_SIZE”: 10000,<br>  “COMPANY_NAME”: “Scantist”,<br>  “COMPANY_LINK”: “<a href="https://scantist.com&quot;" target="_blank" rel="noopener">https://scantist.com&quot;</a>,<br>};</p>
<p><strong>/setting/index.js</strong></p>
<p>// prettier-ignore<br>var const_env = {<br>  “NODE_ENV”: “development”,<br>  “API_BASE”: “<a href="https://localhost:8000/v1&quot;" target="_blank" rel="noopener">https://localhost:8000/v1&quot;</a>,<br>  “PUSHER_KEY”: “765ec374ae0a69f4ce44”,<br>  “PUSHER_HOST”: “localhost”,<br>  “PUSHER_PORT”: “8082”,<br>  “GITHUB_CLIENT_ID”: “5b58ab5f27bbd41fa683”,<br>  “GITHUB_OAUTH_SCOPE”: “user:email,repo”,<br>  “GITLAB_CLIENT_ID”:<br>    “fb68efcd3ca031b40531b44997c4c8b7bed3e69c104a50c69d43aac8a2add50e”,<br>  “GITLAB_OAUTH_SCOPE”: “read_user+read_repository+api”,<br>  “BITBUCKET_CLIENT_ID”: “6CwN8sUj8Q2GkFVDxf”,<br>  “BITBUCKET_OAUTH_SCOPE”: “”,<br>  “BITBUCKET_URL”: “<a href="https://bitbucket.org/site&quot;" target="_blank" rel="noopener">https://bitbucket.org/site&quot;</a>,<br>  “BITBUCKET_SERVER”: “<a href="http://localhost:7990&quot;">http://localhost:7990&quot;</a>,<br>  “CLIENT_URL”: “<a href="http://localhost:8080/callback&quot;" target="_blank" rel="noopener">http://localhost:8080/callback&quot;</a>,<br>  “GITHUB_URL”: “<a href="https://github.com&quot;" target="_blank" rel="noopener">https://github.com&quot;</a>,<br>  “GITLAB_URL”: “<a href="https://gitlab.com&quot;" target="_blank" rel="noopener">https://gitlab.com&quot;</a>,<br>  “STRIPE_PUBLIC_KEY”: “pk_test_3KsWuv3x5d1Sa6k2wXT1UbAJ”,<br>  “CLIENT_ROOT”: “<a href="http://localhost:8080&quot;">http://localhost:8080&quot;</a>,<br>  “IS_ON_PREM”: “true”,<br>  “IS_CHINESE_VERSION”: “false”,<br>  “IS_BITBUCKET_SERVER”: “true”,<br>  “UPLOAD_SIZE”: 10000,<br>  “LOGO_PATH”: “/static/img/scantist_logo.png”,<br>  “LONG_LOGO_PATH”: “/static/img/scantistlogo_whitebg.png”,<br>  “TITLE”: “Scantist SCA”,<br>  “COMPANY_NAME”: “Scantist”,<br>  “COMPANY_LINK”: “<a href="https://scantist.com&quot;" target="_blank" rel="noopener">https://scantist.com&quot;</a>,<br>  “UNPACK_WEBPACK_NANO”: “true”,<br>  “ENABLE_AZURE_SYNC”: “false”,<br>  “SAML_ENABLED”: “true”,<br>  “GITHUB_BROKER”: “false”,<br>  “TOKEN_CREATION”: false,<br>}</p>
<p>window.scantist_env = const_env; //{ …const_env, …env };<br>var keys = Object.keys(env);<br>for (var index = 0; index &lt; keys.length; index++) {<br>  window.scantist_env[keys[index]] = env[keys[index]];<br>}</p>
<p>document.title = window.scantist_env.TITLE;</p>
<p>window.onload = function() {<br>  $(“#html_tab_icon”).attr(“href”, window.scantist_env.LOGO_PATH);<br>};</p>
<p><strong>/static/js/manifest.a9edd26d9ab20bf087d1.js</strong> { “indent_size”: “4”, “indent_char”: “ “, “max_preserve_newlines”: “5”, “preserve_newlines”: true, “keep_array_indentation”: false, “break_chained_methods”: false, “indent_scripts”: “normal”, “brace_style”: “collapse”, “space_before_conditional”: true, “unescape_strings”: false, “jslint_happy”: false, “end_with_newline”: false, “wrap_line_length”: “0”, “indent_inner_html”: false, “comma_first”: false, “e4x”: false, “indent_empty_lines”: false } <strong>static/js/jquery-2.0.3.min.js</strong>   So interestingly, I believe the website is similar in structure as one of the sample site I saw here: <a href="http://www.xinrongji.cc/static/js/" target="_blank" rel="noopener">http://www.xinrongji.cc/static/js/</a> To summarize this section, we know:</p>
<ol>
<li>The target site is communicating with an api-server (<a href="https://api-staging.scantist.io/v1" target="_blank" rel="noopener">https://api-staging.scantist.io/v1</a>).</li>
<li>The authentication on api server is done by Pusher (<a href="https://pusher.com/" target="_blank" rel="noopener">https://pusher.com/)</a>). Access control is done through JWT (JSON Web Token)</li>
<li>Some gitlab/github auth are involved. This is normal, since users can use github/gitlab to sign up.</li>
</ol>
<h5 id="2-Login-Page"><a href="#2-Login-Page" class="headerlink" title="2. Login Page"></a>2. Login Page</h5><p>Use burp to retrieve general information (login through api, sha256 hashed password). After using BurpSuite to trace the traffic redirection, I realize that the site is using JWT token for authentication, which is something that I’m not familiar with. The websites I used to learn information are listed below: <a href="https://medium.com/dev-bits/a-guide-for-adding-jwt-token-based-authentication-to-your-single-page-nodejs-applications-c403f7cf04f4" target="_blank" rel="noopener">https://medium.com/dev-bits/a-guide-for-adding-jwt-token-based-authentication-to-your-single-page-nodejs-applications-c403f7cf04f4</a> <a href="https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/january/jwt-attack-walk-through/" target="_blank" rel="noopener">https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/january/jwt-attack-walk-through/</a> <a href="https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/" target="_blank" rel="noopener">https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/</a> In the last link, brute force on JWT token is introduced as a possible way to attack the server. Since I consider the primary goal is to conduct the penetration test, I skip this section.</p>
<h5 id="3-File-Upload-Function"><a href="#3-File-Upload-Function" class="headerlink" title="3. File Upload Function"></a>3. File Upload Function</h5><p>It is interesting how the server handle uploaded files. After some testing on <strong>Burp</strong>, I summarize the data transfer procedure as below: (1) Initiate a new project and upload a file (or import from github, gitlab, etc.) (2) Upload new files whenever there is a new version. (2.1) Sever back-end use post request to send the data to the target API on /v1/upload/</p>
<p>POST /v1/upload/ HTTP/1.1<br>Host: api-staging.scantist.io<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0<br>Accept: */*<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="https://staging.scantist.io/u/Gelei/org/Gelei/projects/2517" target="_blank" rel="noopener">https://staging.scantist.io/u/Gelei/org/Gelei/projects/2517</a><br>Authorization: Token eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoic2xpZGluZyIsImV4cCI6MTU4NzE0MTE2OCwianRpIjoiYjc0ODM0OGViOWY1NDFjMjgzYjA0OTBiMjUzMTM1OTYiLCJyZWZyZXNoX2V4cCI6MTU4Njg4MTk2OCwidXNlcl9pZCI6MTM1M30.4V0r847Y3mBH-xEXcDkwik4pcz7RUQxm6Qyed2hVaa8<br>Content-Length: 3244<br>Content-Type: multipart/form-data; boundary=—————————2051000857823914733838784542<br>Origin: <a href="https://staging.scantist.io" target="_blank" rel="noopener">https://staging.scantist.io</a><br>Connection: close</p>
<p>—————————–2051000857823914733838784542<br>Content-Disposition: form-data; name=”file”; filename=”sample_python.py”<br>Content-Type: text/x-python</p>
<p>import curses<br>from curses import KEY_RIGHT, KEY_LEFT, KEY_UP, KEY_DOWN<br>from random import randint</p>
<h4 id="following-sections-are-neglected"><a href="#following-sections-are-neglected" class="headerlink" title="following sections are neglected"></a>following sections are neglected</h4><p>(2.2) The api returned the location of file that it is stored on the target server.</p>
<p>HTTP/1.1 201 Created<br>Server: nginx/1.13.0<br>Date: Wed, 15 Apr 2020 16:33:20 GMT<br>Content-Type: application/json<br>Content-Length: 124<br>Connection: close<br>Allow: POST, OPTIONS<br>X-Frame-Options: DENY<br>Vary: Origin<br>Access-Control-Allow-Origin: <a href="https://staging.scantist.io" target="_blank" rel="noopener">https://staging.scantist.io</a><br>Strict-Transport-Security: max-age=60; includeSubDomains<br>X-Content-Type-Options: nosniff<br>X-XSS-Protection: 1; mode=block<br>Strict-Transport-Security: max-age=31536000</p>
<p>{“file”:”<a href="https://scantist-static-staging.s3.amazonaws.com/media/code\_upload/sample\_python.py&quot;,&quot;filename&quot;:&quot;sample\_python.py&quot;}" target="_blank" rel="noopener">https://scantist-static-staging.s3.amazonaws.com/media/code\_upload/sample\_python.py&quot;,&quot;filename&quot;:&quot;sample\_python.py&quot;}</a></p>
<p>Please note that the file is at: <strong>scantist-static-staging.s3.amazonaws.com/media/code_upload/</strong>. The interesting things start from here and I’ll highlight the attack in the next section. (2.3) Client update the corresponding information to <strong>/vi/project/project_number/uploads/</strong></p>
<p>POST /v1/projects/2517/uploads/ HTTP/1.1<br>Host: api-staging.scantist.io<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0<br>Accept: application/json, text/plain, */*<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="https://staging.scantist.io/u/Gelei/org/Gelei/projects/2517" target="_blank" rel="noopener">https://staging.scantist.io/u/Gelei/org/Gelei/projects/2517</a><br>Content-Type: application/json<br>Authorization: Token eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoic2xpZGluZyIsImV4cCI6MTU4NzE0MTE2OCwianRpIjoiYjc0ODM0OGViOWY1NDFjMjgzYjA0OTBiMjUzMTM1OTYiLCJyZWZyZXNoX2V4cCI6MTU4Njg4MTk2OCwidXNlcl9pZCI6MTM1M30.4V0r847Y3mBH-xEXcDkwik4pcz7RUQxm6Qyed2hVaa8<br>Content-Length: 154<br>Origin: <a href="https://staging.scantist.io" target="_blank" rel="noopener">https://staging.scantist.io</a><br>Connection: close</p>
<p>{“download_link”:”sample_python.py”,”file_size”:0.0028772354125976562,”filename”:”sample_python.py”,”file_modified”:”2020-04-15 12:32:41”,”version”:”1.0”}</p>
<p>In return, the server gives “created 201” status code.</p>
<p>HTTP/1.1 201 Created<br>Server: nginx/1.13.0<br>Date: Wed, 15 Apr 2020 16:33:27 GMT<br>Content-Type: application/json<br>Content-Length: 256<br>Connection: close<br>Allow: GET, POST, HEAD, OPTIONS<br>X-Frame-Options: DENY<br>Vary: Origin<br>Access-Control-Allow-Origin: <a href="https://staging.scantist.io" target="_blank" rel="noopener">https://staging.scantist.io</a><br>Strict-Transport-Security: max-age=60; includeSubDomains<br>X-Content-Type-Options: nosniff<br>X-XSS-Protection: 1; mode=block<br>Strict-Transport-Security: max-age=31536000</p>
<p>{“id”:2526,”project”:”2517”,”download_link”:”sample_python.py”,”file_size”:0.0028772354125976562,”created”:”2020-04-16T00:33:27.581668+08:00”,”uploader_name”:”Gelei”,”filename”:”sample_python.py”,”file_modified”:”2020-04-15T12:32:41+08:00”,”version”:”1.0”}</p>
<p>(2.4) After all, the client sends get request on the same api <strong>/vi/project/project_number/uploads/</strong> to get project information. The responses are neglected since they are not directly related to the topic here.   To summarize everything: <strong>three</strong> servers are involved in this process. <em><strong>staging-scantist.io</strong></em> as front-end, <em><strong>api-staging.scantist.io</strong></em> as backend api and <strong>amazon s3 bucket</strong> as the place to store all the files.</p>
<h6 id="Attacks-on-File-Upload-Function-Directory-enumeration-on-api"><a href="#Attacks-on-File-Upload-Function-Directory-enumeration-on-api" class="headerlink" title="Attacks on File Upload Function: Directory enumeration on api"></a>Attacks on File Upload Function: Directory enumeration on api</h6><p>It is worth noticing that in the above example, the sample python file is stored on a certain aws s3 location. After testing, it can be proved that the url is open without any authentication nor authorization. Anyone who knows the link can download files from the S3. For instance: <a href="https://scantist-static-prod.s3.amazonaws.com/media/code_upload/sample_python.py" target="_blank" rel="noopener">https://scantist-static-prod.s3.amazonaws.com/media/code_upload/sample_python.py</a> Since all files are uploaded to this place, we can enumerate in the directory to uncover other’s source code. This can be easily done through <strong>dirbuster</strong>. So many files can be enumerated easily: <img src= "/img/loading.gif" data-src="http://172.245.118.43/wp-content/uploads/2020/04/Screenshot-from-2020-04-15-13-07-31-300x211.png" alt=""> Those files shouldn’t be available to anyone. There might be a chance that some people are uploading the server source code onto this site. In no way should the source code uploaded by other entities be available to random clients from the Internet.</p>
<h6 id="Abuse-File-Upload-Function-JSON-record-modification"><a href="#Abuse-File-Upload-Function-JSON-record-modification" class="headerlink" title="Abuse File Upload Function: JSON record modification"></a>Abuse File Upload Function: JSON record modification</h6><p>While the following section is not testified, I assume that code execution on the remote server is possible. Firstly, I would like to explain how the user upload function can be controlled by users. As mentioned in the previous section, users upload files to target Amazon S3 bucket through a post command to API (and API may help to upload the files to Amazon S3). The upload result in JSON format will then be passed to API that manages the project information.This is realized through the following post request:</p>
<p>POST /v1/projects/<strong><em>project_id</em></strong>/uploads/ HTTP/1.1 HTTP/1.1<br>Host: api-staging.scantist.io</p>
<p>##############<br><em>Other headers and post info</em> #############<br>{“id”:<strong>id</strong>,”project”:<strong>project_id</strong>,”download_link”:”<strong>download_link</strong>“,”file_size”:0.0028772354125976562,”created”:”2020-04-16T00:33:27.581668+08:00”,”uploader_name”:”Gelei”,”filename”:”sample_python.py”,”file_modified”:”2020-04-15T12:32:41+08:00”,”version”:”1.0”}</p>
<p>Yet this post request can be reforged by the user. File name, download link, file size and many other information can be manipulated. For instance: <img src= "/img/loading.gif" data-src="http://172.245.118.43/wp-content/uploads/2020/04/%E6%8D%95%E8%8E%B7-3-288x300.png" alt=""> Though there are limited JS functions to sanitize filename, the post request is not properly sanitized. The filename can be crafted in certain ways that they cannot be downloaded. One example would be the one in the above figure, where <strong>../../</strong> in URL will be falsely interpreted by download request. For instance, some sample log files that I recorded from one of the attacks:</p>
<p>[2020-04-15 22:34:39.201582+08:00]id=14970, [2020-04-15 22:34:39.198196+08:00]id=14970,<br>{‘error’: ‘download_all_from_repo|exception=An error occurred (400) when calling the HeadObject operation: Bad Request,<br>params={\‘e\‘: ClientError(\‘An error occurred (400) when calling the HeadObject operation: Bad Request\‘,),<br>\‘remote_path\‘: “media/code_upload/../../../../../../../../../etc/passwd\‘“,<br>\‘local_file\‘: “./external/clone_dir/upload/2517/file_name_attack_3/../../../../../../../../../etc/passwd\‘“,<br>\‘proj_name\‘: “../../../../../../../../../etc/passwd\‘“,<br>\‘repo_path\‘: \‘./external/clone_dir/upload/2517/file_name_attack_3\‘,<br>\‘repo_name\‘: \‘file_name_attack_3\‘, \‘pro_id\‘: 2517,<br>\‘repo_url\‘: “../../../../../../../../../etc/passwd\‘“}’}</p>
<h6 id="Attack-File-Upload-Function-Possible-Code-Execution"><a href="#Attack-File-Upload-Function-Possible-Code-Execution" class="headerlink" title="Attack File Upload Function: Possible Code Execution"></a>Attack File Upload Function: Possible Code Execution</h6><p>It has been mentioned in the previous section that users can randomly craft file names that are uploaded to the server. Since the server is handling uploaded source code as plain text file, and binary in .zip file. The file should be decompressed first. This is probably done in a way of “unzip <strong>filename</strong>“ on the server. If the file name is properly crafted, for instance, “<strong>test.zip &amp;&amp; <em>ls</em> &amp;.zip”</strong>, then the code execution may become:</p>
<p>unzip test.zip &amp;&amp; ls &amp;.zip</p>
<p>where the files will be executed in sequence. Thus, command execution is possible. Of course, there are higher possibilities that the unzip/scan process is much more complicated than what I assume here. A blind test on code execution is time- consuming. If the source code can be reviewed, I can easily identify if the vulnerability of code execution exists here.</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Grey Deng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://victomteng1997.github.io/2020/04/14/scantist-web-pentest-record/">https://victomteng1997.github.io/2020/04/14/scantist-web-pentest-record/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OffSec/">OffSec</a></div><div class="post_share"><div class="social-share" data-image="https://images.manning.com/360/480/resize/book/2/57c21ee-a252-4089-9b52-8d8d47b08dcc/Pfeffer-PPP-HI.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/22/htb-walkthrough-magic/"><img class="prev-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">[HTB Walkthrough] Magic</div></div></a></div><div class="next-post pull-right"><a href="/2020/04/04/htb-walkthrough-remote/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">[HTB Walkthrough] Remote</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/12/htb-walkthrough-celestial-85-nodejs-for-oswe-practice/" title="[HTB Walkthrough] Celestial 85 Nodejs (for OSWE practice)"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-12</div><div class="relatedPosts_title">[HTB Walkthrough] Celestial 85 Nodejs (for OSWE practice)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/26/htb-walkthrough-cache/" title="[HTB Walkthrough] Cache"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-26</div><div class="relatedPosts_title">[HTB Walkthrough] Cache</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/22/htb-walkthrough-magic/" title="[HTB Walkthrough] Magic"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-22</div><div class="relatedPosts_title">[HTB Walkthrough] Magic</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/16/htb-walkthrough-falafel-for-oswe-practice/" title="[HTB Walkthrough] Falafel (for OSWE practice)"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-16</div><div class="relatedPosts_title">[HTB Walkthrough] Falafel (for OSWE practice)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/19/oswe-atmail-xss-to-rce/" title="OSWE - ATMail XSS to RCE"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-19</div><div class="relatedPosts_title">OSWE - ATMail XSS to RCE</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/20/oswe-blind-sql-injection-and-code-review-continue-on-hacker101/" title="OSWE - Blind SQL Injection and code Review: Continue on Hacker101"><img class="relatedPosts_cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-20</div><div class="relatedPosts_title">OSWE - Blind SQL Injection and code Review: Continue on Hacker101</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var requestSetting = function (from,set) {
  var from = from
  var setting = set.split(',').filter(function(item){
  return from.indexOf(item) > -1
  });
  setting = setting.length == 0 ? from :setting;
  return setting
}

var guestInfo = requestSetting(['nick','mail','link'],'nick,mail,link')
var requiredFields = requestSetting(['nick','mail'],'nick')

window.valine = new Valine({
  el:'#vcomment',
  appId: 'UiwGyBF9TflzCUeBBtJ33gHo-MdYXbMMI',
  appKey: 'tASwtO4JMgE4nzoXkCfS6vQN',
  placeholder: 'Please leave your comments! 畅所欲言!',
  avatar: 'monsterid',
  meta: guestInfo,
  pageSize: '10',
  lang: 'en',
  recordIP: false,
  serverURLs: '',
  emojiCDN: '',
  emojiMaps: "",
  enableQQ: false,
  requiredFields: requiredFields
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Grey Deng</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font_plus" title="Increase Font Size"><i class="fas fa-plus"></i></button><button id="font_minus" title="Decrease Font Size"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":200,"height":400},"mobile":{"show":true},"log":false});</script></body></html>